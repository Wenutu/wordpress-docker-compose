# Docker Compose WordPress æŠ€æœ¯æ ˆ

[English](README.md) | [ä¸­æ–‡](README_CN.md)

åŸºäº Docker Compose çš„é«˜æ€§èƒ½ã€å¯æ‰©å±•ä¸”å®‰å…¨çš„ WordPress éƒ¨ç½²æ–¹æ¡ˆã€‚

## ğŸŒŸ ç‰¹æ€§ / è®¾è®¡ç‰¹ç‚¹

### 1. é«˜æ€§èƒ½æ¶æ„ (LNMP)
- **Nginx ä¸ PHP-FPM è§£è€¦**: ä½¿ç”¨ Nginx ä½œä¸ºä¸“ç”¨çš„åå‘ä»£ç†å’Œé™æ€æ–‡ä»¶æœåŠ¡å™¨ï¼Œä¸ PHP-FPM å¤„ç†å®¹å™¨åˆ†ç¦»ã€‚
- **æ¿€è¿›çš„ç¼“å­˜ç­–ç•¥**: Nginx é…ç½®äº†é•¿è¿‡æœŸæ—¶é—´ (`expires 365d`) ç”¨äºé™æ€èµ„æºï¼ˆå›¾ç‰‡ã€CSSã€JSï¼‰ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘æœåŠ¡å™¨è´Ÿè½½ã€‚

### 2. ç”Ÿäº§ç¯å¢ƒè°ƒä¼˜
- **å¯ç”¨ OPcache**: PHP OPcache é…ç½®ä¸º `validate_timestamps=0`ï¼Œå°†ç¼–è¯‘åçš„è„šæœ¬ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ¶ˆé™¤æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ï¼Œæ˜¾è‘—æé«˜æ‰§è¡Œé€Ÿåº¦ã€‚
- **æ•°æ®åº“ä¼˜åŒ–**: MariaDB åŒ…å«äº†é’ˆå¯¹ InnoDB ç¼“å†²æ±  (`512M`) å’Œè¿æ¥é™åˆ¶çš„ç‰¹å®šè°ƒä¼˜ï¼Œä»¥å¤„ç†æ›´é«˜çš„å¹¶å‘ã€‚

### 3. è‡ªåŠ¨å¯¹è±¡ç¼“å­˜ (Redis)
- **é›¶é…ç½® Redis**: åŒ…å«ä¸€ä¸ªç”¨äº WordPress å¯¹è±¡ç¼“å­˜çš„ Redis å®¹å™¨ã€‚
- **è‡ªåŠ¨åˆå§‹åŒ–**: ä¸€ä¸ªä¸“ç”¨çš„ `wpcli` å®¹å™¨ç›‘æ§å®‰è£…è¿‡ç¨‹ã€‚ä¸€æ—¦ WordPress å®‰è£…å®Œæˆï¼Œå®ƒä¼šè‡ªåŠ¨å®‰è£… Redis æ’ä»¶ï¼Œæ¿€æ´»å®ƒï¼Œå¹¶å¯ç”¨å¯¹è±¡ç¼“å­˜ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

### 4. æ•°æ®æŒä¹…åŒ–ä¸å®‰å…¨
- **å·ç®¡ç†**: æ‰€æœ‰å…³é”®æ•°æ®ï¼ˆæ•°æ®åº“ã€WordPress æ–‡ä»¶ã€Redis æ•°æ®ã€æ—¥å¿—ï¼‰éƒ½æŒä¹…åŒ–åœ¨ç»“æ„åŒ–çš„ `data/` ç›®å½•ä¸­ã€‚
- **ç½‘ç»œéš”ç¦»**: åç«¯æœåŠ¡ï¼ˆæ•°æ®åº“ã€Redisï¼‰åœ¨å†…éƒ¨ Docker ç½‘ç»œä¸Šé€šä¿¡ã€‚

## ğŸ“‹ è¦æ±‚

- Docker Engine
- Docker Compose

## ğŸš€ é…ç½®ä¸ä½¿ç”¨

### 1. ç¯å¢ƒè®¾ç½®
å…‹éš†é¡¹ç›®å¹¶è¿›å…¥ç›®å½•ã€‚åˆ›å»ºæ‚¨çš„ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ä»¥è®¾ç½®æ‚¨çš„å®‰å…¨å¯†ç ï¼š
- `DB_ROOT_PASSWORD`: MariaDB çš„ Root å¯†ç ã€‚
- `DB_PASSWORD`: WordPress æ•°æ®åº“ç”¨æˆ·çš„å¯†ç ã€‚
- `DB_USER`: (å¯é€‰) å¦‚æœéœ€è¦ï¼Œæ›´æ”¹é»˜è®¤ç”¨æˆ·åã€‚
- `DATA_PATH`: æ•°æ®å­˜å‚¨ä½ç½® (é»˜è®¤: `./data`)ã€‚

### 2. å¯åŠ¨æœåŠ¡
åœ¨åå°æ¨¡å¼ä¸‹å¯åŠ¨æœåŠ¡æ ˆï¼š

```bash
docker-compose up -d
```

### 3. å®‰è£… WordPress
- æ‰“å¼€æµè§ˆå™¨å¹¶è®¿é—® `http://localhost:8080` (æˆ–æ‚¨çš„æœåŠ¡å™¨ IP)ã€‚
- å®Œæˆæ ‡å‡†çš„ WordPress 5åˆ†é’Ÿå®‰è£…ã€‚

**æ³¨æ„:** å®Œæˆå®‰è£…åï¼Œåå°çš„ `wpcli` æœåŠ¡ä¼šæ£€æµ‹åˆ°å®‰è£…å¹¶è‡ªåŠ¨å¯ç”¨ Redis å¯¹è±¡ç¼“å­˜ï¼ˆè¿™å¯èƒ½éœ€è¦ 10-20 ç§’ï¼‰ã€‚

### 4. (å¯é€‰) å¤–éƒ¨åå‘ä»£ç†
å¦‚æœæ‚¨ä½¿ç”¨å¤–éƒ¨ Nginx æœåŠ¡å™¨ï¼ˆä¾‹å¦‚åœ¨å®¿ä¸»æœºä¸Šï¼‰æ¥ä»£ç†æµé‡ï¼ˆç«¯å£ 80/443ï¼‰ï¼Œè¯·å°†å…¶é…ç½®ä¸ºå°†è¯·æ±‚è½¬å‘åˆ°æœ¬æœºçš„ `8080` ç«¯å£ã€‚

å®¿ä¸»æœº Nginx é…ç½®ç¤ºä¾‹ï¼š
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## ğŸšš è¿ç§»æŒ‡å—

### ğŸ“¤ å¤‡ä»½ (å¯¼å‡º)

è¦è¿å‡ºæˆ–å¤‡ä»½æ‚¨çš„ç«™ç‚¹ï¼Œæ‚¨éœ€è¦åŒæ—¶ä¿å­˜ **æ•°æ®åº“** å’Œ **æ–‡ä»¶**ã€‚

#### 1. æ•°æ®åº“å¤‡ä»½
ä½¿ç”¨åŒ…å«çš„è„šæœ¬è¿›è¡Œè‡ªåŠ¨åŒ–ã€å®‰å…¨çš„å¤‡ä»½ï¼š

```bash
bash scripts/migration.sh
```
è¿™å°†åœ¨ `data/backup/` ä¸­åˆ›å»ºä¸€ä¸ªå¸¦æ—¶é—´æˆ³çš„ SQL è½¬å‚¨æ–‡ä»¶ã€‚

æˆ–è€…ï¼Œè¿è¡Œæ‰‹åŠ¨å‘½ä»¤ï¼š

```bash
# å¯¼å‡ºæ•°æ®åº“åˆ° SQL æ–‡ä»¶
docker-compose exec db mariadb-dump -u wordpress -p"YOUR_PASSWORD" wordpress > backup.sql
```

#### 2. æ–‡ä»¶å¤‡ä»½
å‹ç¼© `data/wp-app` ç›®å½•ï¼ˆåŒ…å« `wp-content`ã€ä¸Šä¼ ã€ä¸»é¢˜ã€æ’ä»¶ï¼‰ï¼š

```bash
tar -czvf wp-files.tar.gz ./data/wp-app
```

### ğŸ“¥ æ¢å¤ (å¯¼å…¥)

è¦éƒ¨ç½²åˆ°æ–°æœåŠ¡å™¨ï¼š

1. **å‡†å¤‡ç¯å¢ƒ**:
   - å¤åˆ¶ `docker-compose.yaml` å’Œ `.env` åˆ°æ–°æœåŠ¡å™¨ã€‚
   - è¿è¡Œ `docker-compose up -d` ä»¥åˆå§‹åŒ–ç©ºå®¹å™¨ã€‚

2. **æ¢å¤æ–‡ä»¶**:
   å°†æ‚¨çš„æ–‡ä»¶å¤‡ä»½è§£å‹åˆ°æ•°æ®å·è·¯å¾„ä¸­ï¼š
   ```bash
   tar -xzvf wp-files.tar.gz -C ./
   # ç¡®ä¿æƒé™æ­£ç¡® (www-data ç”¨æˆ·åœ¨ Alpine ä¸­é€šå¸¸ id ä¸º 82ï¼Œåœ¨ Debian ä¸­ä¸º 33)
   docker-compose exec wp chown -R www-data:www-data /var/www/html
   ```

3. **æ¢å¤æ•°æ®åº“**:
   å¯¼å…¥æ‚¨çš„ SQL è½¬å‚¨ï¼š
   ```bash
   cat backup.sql | docker-compose exec -T db mariadb -u wordpress -p"YOUR_PASSWORD" wordpress
   ```
4. **é‡å¯æœåŠ¡**:
   ```bash
   docker-compose restart
   ```


## ğŸ›  å®ç”¨è„šæœ¬

- **`scripts/migration.sh`**: åˆ›å»ºæ•°æ®åº“å¤‡ä»½ã€‚
- **`scripts/wpcli_init.sh`**: `wpcli` å®¹å™¨ä½¿ç”¨çš„å†…éƒ¨è„šæœ¬ï¼Œç”¨äºåˆå§‹åŒ– Redisã€‚
